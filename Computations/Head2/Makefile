# set paths
OPENMEEGDATAPATH=../..
OPENMEEGBINPATH=../../src

# general settings
HEADMODELDIR=Head2
COMPUTATIONDIR=Head2
INTERMEDIATEDIR=Head2
TYPE=EEG-point

# forward problem settings
EEGNOISELEVEL=0.00
MEGNOISELEVEL=0.00

# inverse problem settings
EEGDATAWEIGHT=1
MEGDATAWEIGHT=1
SMOOTHWEIGHT=1e-4
SMOOTHTYPE=HEAT
STOPPINGTOL=0
MAXNBITER=10000

# provided files
SOURCEMESH=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR).tri
SOURCEPOINTS=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR).dip
GEOMETRY=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR).geom
CONDUCTIVITY=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR).cond
PATCHES=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR).patches
SQUIDS=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR).squids
REALSOURCESDATA=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR).src
REALSOURCESDATA-POINT=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR).srcdip
REALMEGDATA=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR).meg
REALEEGDATA=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR).eeg

# computed files
LHSMATRIX=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR).lhs
LHSINVMATRIX=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR).lhs_inv
RHSMATRIX=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR).rhs
RHSMATRIX-POINT=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR)-point.rhs
V2EEGMATRIX=$(OPENMEEGDATAPATH)/IntermediateFiles/$(INTERMEDIATEDIR)/$(INTERMEDIATEDIR).v2eeg
S2MEGMATRIX=$(OPENMEEGDATAPATH)/IntermediateFiles/$(INTERMEDIATEDIR)/$(INTERMEDIATEDIR).s2meg
V2MEGMATRIX=$(OPENMEEGDATAPATH)/IntermediateFiles/$(INTERMEDIATEDIR)/$(INTERMEDIATEDIR).v2meg
EEGGAINMATRIX=$(OPENMEEGDATAPATH)/IntermediateFiles/$(INTERMEDIATEDIR)/$(INTERMEDIATEDIR).Heeg
MEGGAINMATRIX=$(OPENMEEGDATAPATH)/IntermediateFiles/$(INTERMEDIATEDIR)/$(INTERMEDIATEDIR).Hmeg

EEGGAINMATRIX-POINT=$(OPENMEEGDATAPATH)/IntermediateFiles/$(INTERMEDIATEDIR)/$(INTERMEDIATEDIR)-point.Heeg
MEGGAINMATRIX-POINT=$(OPENMEEGDATAPATH)/IntermediateFiles/$(INTERMEDIATEDIR)/$(INTERMEDIATEDIR)-point.Hmeg
S2MEGMATRIX-POINT=$(OPENMEEGDATAPATH)/IntermediateFiles/$(INTERMEDIATEDIR)/$(INTERMEDIATEDIR)-point.s2meg

AIVECTOR=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR).ai
SMOOTHMATRIX=$(OPENMEEGDATAPATH)/HeadModels/$(HEADMODELDIR)/$(HEADMODELDIR).smooth
ESTIMATEDSOURCESDATA=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR).est_src
ESTIMATEDMEGDATA=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR).est_meg
ESTIMATEDEEGDATA=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR).est_eeg

ESTIMATEDEEGDATA-POINT=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR)-point.est_eeg
ESTIMATEDMEGDATA-POINT=$(OPENMEEGDATAPATH)/Computations/$(COMPUTATIONDIR)/$(COMPUTATIONDIR)-point.est_meg

# symbolic targets
ifeq "$(TYPE)"  "MEG"
assemble: $(MEGGAINMATRIX)
endif

ifeq "$(TYPE)"  "EEG"
assemble: $(EEGGAINMATRIX)
endif

ifeq "$(TYPE)"  "MEG"
forward: $(ESTIMATEDMEGDATA)
endif

ifeq "$(TYPE)"  "EEG"
forward: $(ESTIMATEDEEGDATA)
endif

ifeq "$(TYPE)"  "MEG-point"
forward: $(ESTIMATEDMEGDATA-POINT)
endif

ifeq "$(TYPE)"  "EEG-point"
forward: $(ESTIMATEDEEGDATA-POINT)
endif

inverse: $(ESTIMATEDSOURCESDATA)

ifeq "$(TYPE)"  "MEG"
forinv:
	$(MAKE) forward
	\cp $(ESTIMATEDMEGDATA) $(REALMEGDATA)
	$(MAKE) inverse
endif

ifeq "$(TYPE)"  "EEG"
forinv:
	$(MAKE) forward
	\cp $(ESTIMATEDEEGDATA) $(REALEEGDATA)
	$(MAKE) inverse
endif

clean:
	rm -f $(LHSMATRIX) $(LHSINVMATRIX) $(RHSMATRIX) $(V2EEGMATRIX) $(S2MEGMATRIX) $(V2MEGMATRIX) $(EEGGAINMATRIX) $(EEGGAINMATRIX) $(MEGGAINMATRIX) $(AIVECTOR) $(SMOOTHMATRIX) $(ESTIMATEDSOURCESDATA) $(ESTIMATEDMEGDATA) $(ESTIMATEDEEGDATA) $(RHSMATRIX1) $(RHSMATRIX2) $(RHSMATRIX3) $(MEGGAINMATRIX1) $(MEGGAINMATRIX2) $(MEGGAINMATRIX3) $(S2MEGMATRIX1) $(S2MEGMATRIX2) $(S2MEGMATRIX3)

$(RHSMATRIX) :  $(GEOMETRY) $(CONDUCTIVITY) $(SOURCEMESH)
	"$(OPENMEEGBINPATH)/om_assemble" -RHS $(GEOMETRY) $(CONDUCTIVITY) $(SOURCEMESH) $(RHSMATRIX)

$(RHSMATRIX-POINT) :  $(GEOMETRY) $(SOURCEPOINTS)
	"$(OPENMEEGBINPATH)/om_assemble" -rhsPOINT $(GEOMETRY) $(CONDUCTIVITY) $(SOURCEPOINTS) $(RHSMATRIX-POINT)

$(LHSMATRIX) : $(GEOMETRY) $(CONDUCTIVITY)
	"$(OPENMEEGBINPATH)/om_assemble" -LHS $(GEOMETRY) $(CONDUCTIVITY) $(LHSMATRIX)

$(V2EEGMATRIX) :  $(GEOMETRY) $(CONDUCTIVITY) $(PATCHES)
	"$(OPENMEEGBINPATH)/om_assemble" -vToEEG $(GEOMETRY) $(CONDUCTIVITY) $(PATCHES) $(V2EEGMATRIX)

$(V2MEGMATRIX) :  $(GEOMETRY) $(CONDUCTIVITY) $(SQUIDS)
	"$(OPENMEEGBINPATH)/om_assemble" -vToMEG $(GEOMETRY) $(CONDUCTIVITY) $(SQUIDS) $(V2MEGMATRIX)

$(S2MEGMATRIX) :  $(SOURCEMESH) $(SQUIDS)
	"$(OPENMEEGBINPATH)/om_assemble" -sToMEG $(SOURCEMESH) $(SQUIDS) $(S2MEGMATRIX)

$(S2MEGMATRIX-POINT) :  $(SOURCEMESH) $(SOURCEPOINTS) $(SQUIDS)
	"$(OPENMEEGBINPATH)/om_assemble" -sToMEG_point $(SQUIDS) $(SOURCEPOINTS) $(S2MEGMATRIX-POINT)

$(S2MEGMATRIX2) :  $(SOURCEMESH) $(SOURCEMESH2) $(SQUIDS)

$(ESTIMATEDEEGDATA) : $(EEGGAINMATRIX) $(REALSOURCESDATA)
	"$(OPENMEEGBINPATH)/om_forward" $(EEGGAINMATRIX)  $(REALSOURCESDATA)  $(ESTIMATEDEEGDATA)  $(EEGNOISELEVEL)

$(ESTIMATEDMEGDATA) : $(MEGGAINMATRIX) $(REALSOURCESDATA)
	"$(OPENMEEGBINPATH)/om_forward" $(MEGGAINMATRIX)  $(REALSOURCESDATA)  $(ESTIMATEDMEGDATA)  $(MEGNOISELEVEL)

$(ESTIMATEDEEGDATA-POINT) : $(EEGGAINMATRIX-POINT) $(REALSOURCESDATA-POINT)
	"$(OPENMEEGBINPATH)/om_forward" $(EEGGAINMATRIX-POINT)  $(REALSOURCESDATA-POINT)  $(ESTIMATEDEEGDATA-POINT)  $(EEGNOISELEVEL)

$(ESTIMATEDMEGDATA-POINT) : $(MEGGAINMATRIX-POINT) $(REALSOURCESDATA-POINT)
	"$(OPENMEEGBINPATH)/om_forward" $(MEGGAINMATRIX-POINT)  $(REALSOURCESDATA-POINT)  $(ESTIMATEDMEGDATA-POINT)  $(MEGNOISELEVEL)

$(EEGGAINMATRIX) : $(LHSINVMATRIX) $(RHSMATRIX) $(V2EEGMATRIX)
	"$(OPENMEEGBINPATH)/om_gain" -EEG $(LHSINVMATRIX)  $(RHSMATRIX)  $(V2EEGMATRIX)  $(EEGGAINMATRIX)

$(MEGGAINMATRIX) : $(LHSINVMATRIX) $(RHSMATRIX) $(V2MEGMATRIX) $(S2MEGMATRIX)
	"$(OPENMEEGBINPATH)/om_gain" -MEG $(LHSINVMATRIX)  $(RHSMATRIX)  $(V2MEGMATRIX)  $(S2MEGMATRIX)  $(MEGGAINMATRIX)

$(EEGGAINMATRIX-POINT) : $(LHSINVMATRIX) $(RHSMATRIX-POINT) $(V2EEGMATRIX)
	"$(OPENMEEGBINPATH)/om_gain" -EEG $(LHSINVMATRIX)  $(RHSMATRIX-POINT)  $(V2EEGMATRIX)  $(EEGGAINMATRIX-POINT)

$(MEGGAINMATRIX-POINT) : $(LHSINVMATRIX) $(RHSMATRIX-POINT) $(V2MEGMATRIX) $(S2MEGMATRIX-POINT)
	"$(OPENMEEGBINPATH)/om_gain" -MEG $(LHSINVMATRIX)  $(RHSMATRIX-POINT)  $(V2MEGMATRIX)  $(S2MEGMATRIX-POINT)  $(MEGGAINMATRIX-POINT)

ifeq "$(TYPE)"  "EEG"
$(ESTIMATEDSOURCESDATA) : $(EEGGAINMATRIX) $(SMOOTHMATRIX) $(REALEEGDATA)
	"$(OPENMEEGBINPATH)/om_inverse" $(EEGGAINMATRIX)  $(SMOOTHMATRIX)  $(AIVECTOR)  $(REALEEGDATA)  $(ESTIMATEDSOURCESDATA) $(SMOOTHWEIGHT)  $(SMOOTHTYPE)  $(MAXNBITER)  $(STOPPINGTOL)
endif

ifeq "$(TYPE)"  "MEG"
$(ESTIMATEDSOURCESDATA) : $(MEGGAINMATRIX) $(SMOOTHMATRIX) $(REALMEGDATA)
	"$(OPENMEEGBINPATH)/om_inverse" $(MEGGAINMATRIX)  $(SMOOTHMATRIX)  $(AIVECTOR)  $(REALMEGDATA)  $(ESTIMATEDSOURCESDATA)  $(SMOOTHWEIGHT)  $(SMOOTHTYPE)  $(MAXNBITER)  $(STOPPINGTOL)
endif

$(LHSINVMATRIX) : $(LHSMATRIX)
	"$(OPENMEEGBINPATH)/om_minverser"  $(LHSMATRIX)  $(LHSINVMATRIX)

$(SMOOTHMATRIX) : $(SOURCEMESH)
	"$(OPENMEEGBINPATH)/om_presmooth"  $(SOURCEMESH)  $(SMOOTHMATRIX)  $(AIVECTOR)

