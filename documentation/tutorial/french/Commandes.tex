\noindent
Sont en \commandName{rouge} les binaires appelés, en \optionName{vert} les options de ces binaires, en \textbf{noir}
les fichiers existants et en \outputName{bleu} les sorties/résultats. 

\section{Assemblage de la matrice $\mathbf{LHS}$~:}
\label{sect: command assemble lhs}

\noindent
Entrées~: 
\begin{itemize}
    \item \fileName{subject.geom}~: fichier de description de la géométrie (voir Annexe~\ref{sect: annexe 1})
    \item \fileName{subject.cond}~: fichier de description des conductivités (voir Annexe~\ref{sect: annexe 2})
\end{itemize}

\noindent
Sortie~:
\begin{itemize}
    \item \outputName{lhsMat.bin}~: fichier binaire où est sauvée la matrice $\mathbf{LHS}$
\end{itemize}

\medskip

\noindent
\command{\commandName{om\_assemble} \optionName{-LHS} subject.geom subject.cond \outputName{lhsMat.bin}}

\section{Assemblage de la matrice $\mathbf{RHS}$~:}
\label{sect: command assemble rhs}

\noindent
Entrées~: 
\begin{itemize}
    \item \fileName{subject.geom}~: fichier de description de la géométrie (voir Annexe~\ref{sect: annexe 1})
    \item \fileName{subject.cond}~: fichier de description des conductivités (voir Annexe~\ref{sect: annexe 2})
    \item la/les source(s)~:
        \begin{description}
            \item [[cas dipolaire]] \fileName{dipolePosition.dip}~: fichier de localisation du/des dipole(s) (coordonnées et orientation)
                                    (voir Annexe~\ref{sect: annexe 3}) 
            \item [[cas des sources distribuées]]  \fileName{sourcemesh}~: maillage de sources (format *.tri de BrainVisa, ou *.mesh de BrainVisa, ou *.vtk de VTK) 
        \end{description}
\end{itemize}

\noindent
Sortie~:
\begin{itemize}
    \item \outputName{rhsMat.bin}~: fichier binaire matrice $\mathbf{RHS}$
\end{itemize}

\medskip

\noindent
Cas dipolaire~:\\
\noindent
\command{\commandName{om\_assemble} \optionName{-rhsPOINT} subject.geom subject.cond dipolePosition.dip \outputName{rhsMat.bin}}

\medskip

\noindent
Cas des sources distribuées~:\\
\noindent
\command{\commandName{om\_assemble} \optionName{-RHS} subject.geom subject.cond sourcemesh \outputName{rhsMat.bin}}

\section{Inversion de la matrice $\mathbf{LHS}$~:}
\label{sect: command invert lhs}

\noindent
Entrées~:
\begin{itemize}
    \item \fileName{lhsMat.bin}~: matrice $\mathbf{LHS}$
\end{itemize}

\noindent
Sortie~:
\begin{itemize}
    \item \outputName{lhsInvMat.bin}~: fichier binaire matrice $\mathbf{LHS}^{-1}$
\end{itemize}

\medskip

\noindent
\command{\commandName{om\_minverser} lhsMat.bin \outputName{lhsInvMat.bin}}

\section{Calcul de l'application linéaire qui à X associe le potentiel aux capteurs~:}
\label{sect: command assemble sensors}

\checkItem \underline{Cas de l'EEG}~:\\
"La méthode BEM symétrique fournit le potentiel électrique aux sommets des maillages de toutes les interfaces. Pour simuler le
potentiel à une électrode donnée, on projette sa position sur la dernière interface (censée modéliser le scalp) et on interpole
ensuite la valeur en ce point grâce aux fonctions P1.  [...] on considère [...] un modèle de tête ainsi que des positions de
capteurs EEG et MEG fixes par rapport à ce modèle. Le passage des valeurs du potentiel électrique de l'interface la plus externe
aux électrodes est donc une opération linéaire (par rapport aux valeurs du potentiel sur la dernière couche)."
\emph{\underline{\textcolor{blue}{Extrait de la thèse de Geoffray Adde "Méthodes de traitement d'image appliquées au}}}\\
\emph{\underline{\textcolor{blue}{problème inverse en magnéto-électro-encéphalographie"}}  p.62-63.}

\medskip

\noindent
On a alors~: $\mathbf{V_{electrode}} = \mathbf{vToEEG} . \mathbf{X}$\\
où~:\\ 
\begin{itemize}
    \item $\mathbf{V_{electrode}}$ est la matrice des valeurs du potentiel électrique aux électrodes (ce que l'on cherche),
    \item $\mathbf{X}$ est la matrice contenant les valeurs du potentiel électrique en chaque sommet de la triangulation de la
          surface la plus externe,
    \item $\mathbf{vToEEG}$ est la matrice de passage que l'on doit assembler.
\end{itemize}

\bigskip

\noindent
Entrées~:
\begin{itemize}
    \item \fileName{subject.geom}~: fichier de description de la géométrie (voir Annexe~\ref{sect: annexe 1})
    \item \fileName{subject.cond}~: fichier de description des conductivités (voir Annexe~\ref{sect: annexe 2})
    \item \fileName{patchespositions.txt}~: fichier des positions capteurs eeg (voir Annexe~\ref{sect: annexe 4})
\end{itemize}
Sortie~:
\begin{itemize}
    \item \outputName{v2eegMat.bin}~: fichier binaire matrice $\mathbf{vToEEG}$
\end{itemize}

\medskip

\noindent
\command{\commandName{om\_assemble} \optionName{-vToEEG} subject.geom subject.cond patchespositions.txt \outputName{v2eegMat.bin}}

\bigskip

\checkItem \underline{Cas de la MEG}~:\\
Dans le cas de la MEG la décomposition est un peu plus complexe. Je t'invite a regarder la thèse de Geoffray
(\href{http://pastel.paristech.org/1593/}{ici}). On a un calcul d'intégrale à faire sur l'espace des sources ce qui implique non
seulement l'assemblage de la matrice de passage du potentiel sur la dernière surface au potentiel sur les capteurs mais aussi
l'assemblage de la matrice de contribution de la discrétisation des sources (maillage de sources dans le cas de sources
distribuées et position et orientation de dipôles dans le cas dipolaire).\\
On a alors~: $\mathbf{M_{capteur}} = \mathbf{sToMEG} . \mathbf{S} + \mathbf{vToMEG}.\mathbf{X}$.

\medskip

\noindent
\underline{Assemblage de la matrice de passage du potentiel ($\mathbf{vToMEG}$)}~:\\
Entrées~:
\begin{itemize}
    \item \fileName{subject.geom}~: fichier de description de la géométrie (voir Annexe~\ref{sect: annexe 1})
    \item \fileName{subject.cond}~: fichier de description des conductivités (voir Annexe~\ref{sect: annexe 2})
    \item \fileName{sensorpositions.txt}~: fichier des positions et orientation de capteurs meg (voir Annexe~\ref{sect: annexe 4})
\end{itemize}
Sortie~:
\begin{itemize}
    \item \outputName{v2megMat.bin}~: fichier binaire matrice $\mathbf{vToMEG}$
\end{itemize}

\medskip

\noindent
\command{\commandName{om\_assemble} \optionName{-vToMEG} subject.geom subject.cond sensorpositions.txt \outputName{v2megMat.bin}}

\bigskip

\noindent
\underline{Assemblage de la matrice de contribution des sources ($\mathbf{sToMEG}$)}~:\\
Entrées~:
\begin{itemize}
    \item la/les source(s)~:
    \begin{description}
        \item [[cas dipolaire]] \fileName{dipolePosition.dip}~: fichier de localisation du/des dipole(s) (coordonnées et orientation) (voir Annexe~\ref{sect: annexe 3}) 
        \item [[cas des sources distribuées]] \fileName{sourcemesh}~: maillage de sources (format *.tri, ou *.mesh, ou *.vtk)
    \end{description}
    \item \fileName{sensorpositions.txt}~: fichier des positions et orientation de capteurs meg (voir Annexe~\ref{sect: annexe 4})
\end{itemize}
Sortie~: 
\begin{itemize}
    \item \outputName{s2megMat.bin}~: fichier binaire matrice $\mathbf{sToMEG}$
\end{itemize}

\medskip

\noindent
Cas dipolaire~:\\
\noindent
\command{\commandName{om\_assemble} \optionName{-sToMEG\_point} dipolePosition.dip sensorpositions.txt \outputName{s2megMat.bin}}

\medskip

\noindent
Cas des sources distribuées~:\\
\noindent
\command{\commandName{om\_assemble} \optionName{-sToMEG} sourcemesh sensorpositions.txt \outputName{s2megMat.bin}}

\section{Calcul de la matrice de Gain~:}
\label{sect: command gain}

La matrice de gain est la matrice qui lie \textbf{la position et l'orientation des sources} à la position (et l'orientation dans le cas
de la MEG) des capteurs. 

\checkItem \underline{Cas de l'EEG}~:\\
Entrées~:
\begin{itemize}
    \item \fileName{lhsInvMat.bin}~: fichier binaire matrice $\mathbf{LHS}^{-1}$
    \item \fileName{rhsMat.bin}~: fichier binaire matrice $\mathbf{RHS}$
    \item \fileName{v2eegMat.bin}~: fichier binaire matrice $\mathbf{vToEEG}$
\end{itemize}
Sortie~:
\begin{itemize}
    \item \outputName{gainMat.bin}~: fichier binaire matrice de gain
\end{itemize}

\medskip

\noindent
\command{\commandName{om\_gain} \optionName{-EEG} lhsInvMat.bin rhsMat.bin v2eegMat.bin \outputName{gainMat.bin}}


\bigskip

\checkItem\underline{Cas de la MEG}~:\\
Entrées~:
\begin{itemize}
    \item \fileName{lhsInvMat.bin}~: fichier binaire matrice $\mathbf{LHS}^{-1}$
    \item \fileName{rhsMat.bin}~: fichier binaire matrice $\mathbf{RHS}$
    \item \fileName{v2megMat.bin}~: fichier binaire matrice $\mathbf{vToMEG}$
    \item \fileName{s2megMat.bin}~: fichier binaire matrice $\mathbf{sToMEG}$
\end{itemize}
Sortie~:
\begin{itemize}
    \item \outputName{gainMat.bin}~: fichier binaire matrice de gain
\end{itemize}

\medskip

\noindent
\command{\commandName{om\_gain} \optionName{-MEG} lhsInvMat.bin rhsMat.bin v2megMat.bin s2megMat.bin \outputName{gainMat.bin}}


\section{Le problème direct~:}
\label{sect: command direct}

Il s'agit d'indiquer comment sont activées les sources et d'appliquer cette activation à la matrice de gain. 
Entrées~: 
\begin{itemize}
    \item \fileName{gainMat.bin}~: fichier binaire matrice de gain
    \item \fileName{activationSources.txt}~: fichier de description de l'état d'activation des sources (voir Annexe~\ref{sect: annexe 5})
    \item \fileName{noise}~: bruit (réel positif ou nul)
\end{itemize}
Sortie:
\begin{itemize}
    \item \outputName{sensorResults.txt}~: vecteur résultat des valeurs simulées aux capteurs.
\end{itemize}

\medskip

\noindent
\command{\commandName{om\_forward} gainMat.bin activationSources.txt \outputName{sensorResults.txt} noise}
